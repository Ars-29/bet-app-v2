# Bet Placement & Calculation - unibet-api API and Data Flow Documentation (Comprehensive)

## Overview
Complete reference for bet placement, retrieval, and outcome calculation in `UNIBET-API`. Includes all endpoints, FotMob integration, caches, calculator utilities, and data models. Use this to drive migration planning to bet-app while keeping the existing UI.

---

## Placement & Retrieval APIs (UNIBET-API/server.js)

### Placement
- `POST /api/bets` – Place a bet
  - Required: `eventId, marketId, outcomeId, stake, odds`
  - Optional enrichers: `eventName, marketName, criterionLabel, criterionEnglishLabel, participant, participantId, eventParticipantId, betType, betOfferTypeId, handicapRaw, handicapLine, leagueId, leagueName, homeName, awayName, start, potentialWin`
  - Behavior: Inserts into Mongo `bets` (anonymous user), enriches missing league/team/start using `ALL_FOOTBALL_CACHE`

### Retrieval & Admin
- `GET /api/bets/event/:eventId` – Bets for event
- `GET /api/bets/league/:leagueId` – Bets for league
- `GET /api/bets` – All bets (admin)
- `GET /api/bets/needs-attention` – Bets flagged for manual review
- `POST /api/bets/:betId/resolve` – Manually resolve a bet (won/lost/cancelled)
- `PUT /api/bets/:betId` – Update a bet

---

## Outcome Processing APIs (UNIBET-API/server.js)

- `POST /api/bets/process-outcomes` – Smart processing (finished matches only; default)
- `POST /api/bets/process-outcomes-all` – Legacy mode (all pending)
- `POST /api/bets/process-outcomes-manual` – Immediate processing
- `POST /api/bets/:betId/process-outcome` – Process specific bet
- `POST /api/bets/:betId/process-outcome-with-match/:matchId` – Process a bet using known FotMob `matchId`
- Automation:
  - `POST /api/bets/schedule-processing` – Start scheduler
  - `POST /api/bets/stop-processing` – Stop scheduler
  - `GET /api/bets/processing-status` – Current status
  - `POST /api/bets/update-config` – Peak hours/intervals
  - `GET /api/bets/config` – Current config
  - `GET /api/bets/processing-stats` – Aggregated stats

---

## FotMob Integration (Data Source for Outcomes)

UNIBET-API relies on FotMob for ground-truth match results and stats used in outcome calculations.

### FotMob Endpoints (UNIBET-API/server.js)
- `POST /api/fotmob/clear-cache` – Delete `fotmob_multiday_cache.json` + `fotmob_cache_meta.json`
- `POST /api/fotmob/refresh-cache/:date?` – Refresh daily cache for provided date (YYYY-MM-DD) or today
- `POST /api/fotmob/refresh-multiday-cache` – Build a multi-day cache window
- `GET /api/fotmob/cache-content` – Return raw multi-day cache content
- `GET /api/fotmob/cache-analysis` – Analysis of cache (counts, sample leagues)
- `GET /api/fotmob/cache-stats` – Stats of cache
- `GET /api/fotmob/auto-refresh-status` – Auto-refresh status
- `POST /api/fotmob/trigger-auto-refresh` – Trigger background refresh
- `GET /api/test-fotmob/:date?` – Test endpoint to fetch and summarize FotMob matches

### FotMob Libraries & Caches
- Library: `@max-xoo/fotmob` – Used in both `server.js` and `bet-outcome-calculator.js`
- Cache files:
  - `UNIBET-API/fotmob_multiday_cache.json` – Primary multi-day store
  - `UNIBET-API/fotmob_cache_meta.json` – Refresh metadata
  - Per-day caches generated by calculator (e.g., `fotmob_matches_<dateStr>_<ISO-date>.json`)

---

## Core Calculator & Utilities

### Calculator Class
- File: `UNIBET-API/bet-outcome-calculator.js`
- Responsibilities:
  - Fetch FotMob data (daily and multi-day)
  - Load league mapping (`league_mapping_clean.csv`) to map Unibet ↔ FotMob leagues
  - Identify market family and specifics
  - Calculate outcomes per market using FotMob match details
  - Rate limiting, scheduling, and processing stats
- Key fields:
  - `this.fotmob = new Fotmob()`
  - `this.leagueMapping = new Map()`
  - `this.config = { peakHours, intervals, rateLimit }`
  - `this.isProcessingRunning`, `this.processingStats`
- Key methods (selected):
  - `loadLeagueMapping()` – loads CSV → `leagueMapping`
  - `fetchFotmobMatches(dateStr, forceRefresh?)` – acquire daily data (cache-aware)
  - `getCachedDailyMatches(date)` / `getMultiDayCache()` – local caching helpers
  - `findMatchingFotmobMatch(bet, fotmobData)` – map stored bet → specific FotMob match (by league mapping, teams, date)
  - `processAllPendingBets(onlyFinished=true)` – smart batch processor
  - `processAllPendingBetsLegacy()` / `processAllPendingBetsManual()` – alternative processors
  - `processBetWithMatchId(bet, fotmobMatchId)` – targeted processing
  - `determineMarketFamily(bet)` – result/totals/cards/corners/player/time
  - `getBasicDerivedFacts(matchDetails)` – debug helpers (final score, HT/2H, cards, corners, fouls)

### Utilities Used by Calculator
- `UNIBET-API/utils/fotmob-helpers.js`
  - Line normalization: `normalizeLine(rawLine)`
  - Score and half splits: `getFinalScore`, `getHalftimeScore`, `getSecondHalfScore`
  - Interval goals: `getTeamGoalsByInterval`, `getGoalsInWindow`, `getFirstGoalAfterMinute`, `getNthGoal`
  - Cards & corners: `getTeamCards`, `getCornersFromStats`, `getFoulsFromStats`
  - Team helpers: `getTeamNames`
  - Player utilities: `getPlayerStats`, `getPlayerEvents`, `findPlayerIdByName`
  - Event/minute parsing helpers: `getAbsoluteMinuteFromEvent`, `isWithinWindow`

- `UNIBET-API/utils/market-normalizer.js`
  - `normalizeBet(rawBet)` → returns canonical fields and hints (player market, time window, line normalization, selection normalization)
  - Heuristic milli → decimal detection for Unibet lines

- `UNIBET-API/utils/market-registry.js`
  - `MARKET_REGISTRY` – ordered rules to identify precise market codes
  - `identifyMarket(bet, norm)` – returns `MarketCodes` (e.g., `PLAYER_TO_SCORE`, `PLAYER_SOT_OU`, `TEAM_TOTAL_GOALS_OU`, `CORNERS_*`, `MATCH_TOTAL_GOALS_*`, etc.)

- League Mapping CSV
  - `UNIBET-API/league_mapping_clean.csv` (Unibet league → FotMob league ID/name)

- Additional data files referenced by tests or ops
  - `UNIBET-API/fotmob_match_details_4732664_2025-09-09.json` (fixture used in extractor/calculator tests)

---

## Placement Data Model (Stored Document)

From `server.js` placement handler:
```json
{
  "eventId": "string",
  "eventName": "string|null",
  "marketId": "string",
  "marketName": "string|null",
  "criterionLabel": "string|null",
  "criterionEnglishLabel": "string|null",
  "outcomeId": "string",
  "outcomeLabel": "string|null",
  "outcomeEnglishLabel": "string|null",
  "participant": "string|null",
  "participantId": "string|null",
  "eventParticipantId": "string|null",
  "odds": 2.35,
  "stake": 10,
  "potentialWin": 23.5,
  "betType": "single",
  "betOfferTypeId": "string|null",
  "handicapRaw": 0.5,
  "handicapLine": 0.5,
  "leagueId": "string|null",
  "leagueName": "string|null",
  "homeName": "string|null",
  "awayName": "string|null",
  "start": "2025-09-19T22:00:00.000Z",
  "userId": "anonymous",
  "status": "pending",
  "matchFinished": false,
  "createdAt": "ISO",
  "updatedAt": "ISO"
}
```

---

## Outcome Processing Flow
```
Pending bets in Mongo → outcome processor called (smart/legacy/manual)
  → Loads required match/market data (from caches/APIs)
  → For each bet: compute result (won/lost/cancelled) and potentialWin
  → Update bet document (status, result, updatedAt)
```

Entry points:
- `POST /api/bets/process-outcomes` (finished matches)
- `POST /api/bets/process-outcomes-all` (all)
- `POST /api/bets/process-outcomes-manual` (immediate)
- `POST /api/bets/:betId/process-outcome` (single)
- `POST /api/bets/:betId/process-outcome-with-match/:matchId` (targeted)

---

## Differences vs bet-app (Migration Considerations)
- **Auth & Users**: unibet-api uses `userId: 'anonymous'` (no auth/balance). bet-app has auth, balance deduction, conflict prevention.
- **Placement Payloads**: unibet-api expects Unibet-native identifiers; bet-app uses `betDetails.market_id` and internal market mappings.
- **Outcome Source**: unibet-api → FotMob truth; bet-app → SportsMonk/Websocket/own calculators.
- **Architecture**: unibet-api centralizes routes in `server.js` + `bet-outcome-calculator.js`; bet-app uses routers/controllers/services.

---

## Quick Reference (Paths)
- Endpoints & handlers: `UNIBET-API/server.js`
- Calculator: `UNIBET-API/bet-outcome-calculator.js`
- Utilities: `UNIBET-API/utils/fotmob-helpers.js`, `UNIBET-API/utils/market-normalizer.js`, `UNIBET-API/utils/market-registry.js`
- League mapping: `UNIBET-API/league_mapping_clean.csv`
- Cache files: `UNIBET-API/fotmob_multiday_cache.json`, `UNIBET-API/fotmob_cache_meta.json`
- Admin/test UIs: `UNIBET-API/public/bets.html`, `UNIBET-API/public/bet-processing.html`
- Ops/Test scripts: `UNIBET-API/check-bet-statuses.js`, `UNIBET-API/scripts/*.js`

---

Last Updated: 2025-09-17
